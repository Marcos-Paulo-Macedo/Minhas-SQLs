--------------------------------------
-- SQL DE CORRECAO
UPDATE CLIFORS C
SET C.EMAIL = TRIM(UPPER(TRIM(COALESCE(C.EMAIL,'')))),
    C.OBSERVACAO = TRIM(UPPER(TRIM(COALESCE(C.OBSERVACAO,'')))) ;
    
--------------------------------------
-- CORRIGIR GRUPO CLIENTE
SELECT C.CLIFOR_ID, C.EMAIL, G.CLIFORGRUPO_ID
FROM CLIFORS C
LEFT JOIN CLIFORGRUPOS G
ON  (TRIM(COALESCE(G.NOME,'')) = TRIM(COALESCE(C.EMAIL,'')))
WHERE (TRIM(COALESCE(C.EMAIL,'')) <> '')

--------------------------------------
--BLOCO DE CODIGO PARA SEPARAR A UF
EXECUTE BLOCK
RETURNS (
    CLIFOR_ID INTEGER,
    OBSERVACAO_ORIG VARCHAR(100), --CIDADE
    OBSERVACAO VARCHAR(100),
    SITUACAOTRIBUTARIA VARCHAR(10)) --UF
AS
DECLARE VARIABLE NESTADO INTEGER;
DECLARE VARIABLE NPOSICAO INTEGER;
BEGIN
    FOR SELECT C.CLIFOR_ID, C.OBSERVACAO
        FROM CLIFORS C
        WHERE (TRIM(COALESCE(C.OBSERVACAO,'')) <> '')
         AND  (COALESCE(C.SITUACAOTRIBUTARIA,'') = '')
    INTO :CLIFOR_ID, :OBSERVACAO_ORIG DO
    BEGIN
        NPOSICAO = POSITION('-',OBSERVACAO_ORIG,1);

        IF (NPOSICAO > 0) THEN
        BEGIN
          OBSERVACAO = SUBSTRING(OBSERVACAO_ORIG FROM 1 FOR (NPOSICAO -1));
          SITUACAOTRIBUTARIA = '';
          IF ((CHAR_LENGTH(OBSERVACAO_ORIG)-NPOSICAO) > 0) THEN
            BEGIN
            NESTADO = (CHAR_LENGTH(OBSERVACAO_ORIG)-NPOSICAO);
            IF (NESTADO > 2) THEN
              NESTADO = 2;
            SITUACAOTRIBUTARIA  = TRIM(SUBSTRING(OBSERVACAO_ORIG FROM (NPOSICAO+1) FOR NESTADO));
          END
          SUSPEND;
        END
    END
END
--------------------------------------
-- CRIACAO DAS CIDADES
SELECT GEN_ID(CIDADE,1) AS CIDADE_ID,
       SEL.OBSERVACAO AS NOME,
       SEL.SITUACAOTRIBUTARIA AS ESTADO
FROM
(
    SELECT DISTINCT TRIM(COALESCE(C.OBSERVACAO,''))AS OBSERVACAO,
                    TRIM(COALESCE(C.SITUACAOTRIBUTARIA,'')) AS SITUACAOTRIBUTARIA
    FROM CLIFORS C
    WHERE (TRIM(COALESCE(C.OBSERVACAO,'')) <> '')
     AND  (COALESCE(C.SITUACAOTRIBUTARIA,'') <> '')
) SEL

--------------------------------------
--CORRIGIR CIDADE DO CLIENTE
SELECT C.CLIFOR_ID,
       CI.CIDADE_ID
FROM CLIFORS C
LEFT JOIN CIDADES CI
ON  (TRIM(COALESCE(CI.NOME,'')) = TRIM(COALESCE(C.OBSERVACAO,'')))
AND (TRIM(COALESCE(CI.ESTADO,'')) = TRIM(COALESCE(C.SITUACAOTRIBUTARIA,'')))
WHERE (TRIM(COALESCE(C.OBSERVACAO,'')) <> '')
 AND  (COALESCE(C.SITUACAOTRIBUTARIA,'') <> '')

--------------------------------------
